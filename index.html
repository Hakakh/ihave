<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>L√≠nh ƒê·∫∑c C√¥ng T·∫≠p Tr·∫£ L·ªùi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f8ff;
            padding: 10px;
            line-height: 1.6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 700px;
            width: 100%;
            margin: 10px auto;
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        #gameCanvas {
            border: 2px solid #007bff;
            background-color: #87ceeb;
            display: block;
            margin: 10px auto;
            width: 100%;
            max-width: 680px;
            height: 300px;
        }

        .game-info {
            margin: 10px 0;
            font-size: 1em;
            color: #555;
        }

        .question {
            margin: 15px 0 10px 0;
            font-size: 1.1em;
            font-weight: bold;
            color: #0056b3;
        }

        .target-sentence {
            margin-top: 5px;
            font-size: 1.2em;
            color: #007bff;
            font-weight: bold;
        }

        .answer-box {
            background: #eef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            min-height: 1.2em;
            text-align: left;
            word-wrap: break-word;
            border: 1px solid #cce;
            font-size: 0.95em;
        }

        button {
            margin: 8px 4px;
            padding: 10px 15px;
            font-size: 0.95em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        button:active {
            transform: scale(0.98);
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .feedback {
            background: #e0ffe0;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: left;
            border: 1px solid #a3e0a3;
            font-weight: bold;
            font-size: 0.95em;
        }

        .results-display {
            background: #fff8e1;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            text-align: left;
            border: 1px solid #ffecb3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 0.95em;
        }

        .results-display h3 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            font-size: 1.3em;
        }

        .results-display p {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
        }
        .results-display p:last-child {
            border-bottom: none;
        }

        .results-display strong {
            color: #007bff;
        }

        .results-display em {
            color: #555;
        }

        .results-display button {
            display: block;
            margin: 15px auto 8px auto;
            background-color: #28a745;
        }
        .results-display button:hover {
            background-color: #218838;
        }

        #copyFeedback {
            margin-top: 10px;
            font-size: 0.9em;
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }
        #copyFeedback a {
            color: #0056b3;
            font-weight: bold;
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 10px;
                margin: 5px auto;
            }
            h1 {
                font-size: 1.5em;
                margin-bottom: 10px;
            }
            #gameCanvas {
                height: 250px;
            }
            button {
                padding: 8px 12px;
                font-size: 0.9em;
                margin: 5px 3px;
            }
            .question {
                font-size: 1em;
                margin: 10px 0;
            }
            .answer-box, .feedback, .results-display {
                font-size: 0.9em;
                padding: 8px;
            }
            .results-display h3 {
                font-size: 1.2em;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
</head>
<body>
    <div class="container">
        <h1>L√≠nh ƒê·∫∑c C√¥ng T·∫≠p Tr·∫£ L·ªùi</h1>

        <div class="game-info">
            C√¢u ƒë√£ tr·∫£ l·ªùi: <span id="sentencesCleared">0</span> / T·ªïng s·ªë: <span id="totalSentences">0</span>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div id="questionArea" class="question">B·∫•m "B·∫Øt ƒë·∫ßu" ƒë·ªÉ nghe c√¢u h·ªèi.</div>
        <div id="targetSentenceArea" class="target-sentence" style="display: none;"></div>

        <div>
            <button onclick="window.speakQuestion()" id="startButton">üîä B·∫Øt ƒë·∫ßu</button>
            <button onclick="window.startRecognition()" id="answerButton">üé§ Tr·∫£ l·ªùi</button>
        </div>
        <div id="transcript" class="answer-box"></div>
        <div id="feedback" class="feedback" style="display: none;"></div>

        <div>
            <button onclick="window.nextSentence()" id="nextButton" disabled>‚û°Ô∏è C√¢u ti·∫øp theo</button>
            <button onclick="window.displayResults()" id="viewResultsButton">üìä Xem k·∫øt qu·∫£</button>
        </div>

        <div id="resultsDisplayArea" class="results-display" style="display: none;"></div>
    </div>

    <script>
        // --- C·∫•u h√¨nh Game v√† C√¢u tr·∫£ l·ªùi ---
        const sentenceList = [
            { sentence: "I have a dog.", emoji: "üê∂" },
            { sentence: "I have a big house.", emoji: "üè†" },
            { sentence: "I have a new laptop.", emoji: "üíª" },
            { sentence: "I have a red bicycle.", emoji: "üö¥" },
            { sentence: "I have a great idea.", emoji: "üí°" },
            { sentence: "I have a test tomorrow.", emoji: "üìù" },
            { sentence: "I have a good friend.", emoji: "üëØ" },
            { sentence: "I have a lot of homework.", emoji: "üìö" },
            { sentence: "I have an orange pen.", emoji: "üñäÔ∏è" },
            { sentence: "I have a blue bag.", emoji: "üéí" },
            { sentence: "I have a small garden.", emoji: "üå±" },
            { sentence: "I have a smart phone.", emoji: "üì±" },
            { sentence: "I have an old bicycle.", emoji: "üö≤" },
            { sentence: "I have a younger sister.", emoji: "üëß" },
            { sentence: "I have a new teacher.", emoji: "üë©‚Äçüè´" },
            { sentence: "I have a beautiful flower.", emoji: "üå∏" },
            { sentence: "I have an English book.", emoji: "üìñ" },
            { sentence: "I have a math test.", emoji: "‚ûó" },
            { sentence: "I have a black jacket.", emoji: "üß•" },
            { sentence: "I have a white T-shirt.", emoji: "üëï" },
            { sentence: "I have a red apple.", emoji: "üçé" },
            { sentence: "I have a nice watch.", emoji: "‚åö" },
            { sentence: "I have a lot of friends.", emoji: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶" },
            { sentence: "I have a cute puppy.", emoji: "üêï" },
            { sentence: "I have a robot.", emoji: "ü§ñ" }
        ];

        let currentSentenceIndex = 0;
        let playerAttempts = new Array(sentenceList.length).fill(0);
        let isAnsweredCorrectly = false;

        // --- DOM Elements ---
        const questionArea = document.getElementById("questionArea");
        const targetSentenceArea = document.getElementById("targetSentenceArea");
        const transcriptDiv = document.getElementById("transcript");
        const feedbackDiv = document.getElementById("feedback");
        const resultsDisplayArea = document.getElementById("resultsDisplayArea");
        const startButton = document.getElementById("startButton");
        const answerButton = document.getElementById("answerButton");
        const nextButton = document.getElementById("nextButton");
        const viewResultsButton = document.getElementById("viewResultsButton");
        const sentencesClearedSpan = document.getElementById("sentencesCleared");
        const totalSentencesSpan = document.getElementById("totalSentences");

        // --- Canvas Setup ---
        const canvas = document.getElementById("gameCanvas");
        let ctx = canvas.getContext("2d");

        let canvasWidth;
        let canvasHeight;

        // --- Game Variables ---
        const groundHeight = 40;
        let groundY;
        const playerSize = 40;
        const playerColor = "#006400";
        const playerShapeSize = 40;
        let playerY;
        let playerGroundY;
        const playerX = 50;

        const emojiSize = 60;
        const emojiY = 120;
        let emojiTarget = { x: 0, y: emojiY, width: emojiSize, height: emojiSize, cleared: false };

        // Bi·∫øn cho hi·ªáu ·ª©ng b·∫Øn
        let bulletX;
        let bulletY;
        const bulletSpeed = 15;
        let isShooting = false;

        // --- Audio Setup (using Tone.js) ---
        let shootSynth = null;

        // --- Function Definitions ---

        function resizeCanvas() {
            canvasWidth = canvas.clientWidth;
            canvasHeight = canvas.clientHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            ctx = canvas.getContext("2d");
            groundY = canvasHeight - groundHeight;
            playerGroundY = canvasHeight - groundHeight - playerSize;
            playerY = playerGroundY;
            bulletX = playerX + playerSize * 0.7;
            bulletY = playerY + playerSize * 0.5;
            initializeEmojiTarget();
        }

        function initializeEmojiTarget() {
            emojiTarget.x = canvasWidth - emojiSize - 50;
            emojiTarget.y = emojiY;
            emojiTarget.cleared = false;
        }

        function drawGround() {
            ctx.fillStyle = "#a0522d";
            ctx.fillRect(0, groundY, canvasWidth, groundHeight);
        }

        function drawPlayer() {
            ctx.fillStyle = playerColor;
            ctx.fillRect(playerX + playerShapeSize * 0.2, playerY, playerShapeSize * 0.6, playerShapeSize * 0.8);
            ctx.beginPath();
            ctx.arc(playerX + playerShapeSize / 2, playerY - playerShapeSize * 0.3, playerShapeSize * 0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillRect(playerX + playerShapeSize * 0.1, playerY + playerShapeSize * 0.8, playerShapeSize * 0.3, playerShapeSize * 0.2);
            ctx.fillRect(playerX + playerShapeSize * 0.6, playerY + playerShapeSize * 0.8, playerShapeSize * 0.3, playerShapeSize * 0.2);
            ctx.fillRect(playerX + playerShapeSize * 0.7, playerY + playerShapeSize * 0.2, playerShapeSize * 0.3, playerShapeSize * 0.15);
            ctx.fillRect(playerX + playerShapeSize * 0.7, playerY + playerShapeSize * 0.4, playerShapeSize * 0.3, playerShapeSize * 0.15);
            ctx.fillStyle = "#333";
            ctx.fillRect(playerX + playerShapeSize, playerY + playerShapeSize * 0.5, playerShapeSize * 0.5, playerShapeSize * 0.1);
        }

        function drawEmojiTarget() {
            if (emojiTarget.cleared || currentSentenceIndex >= sentenceList.length) return;
            ctx.font = `${emojiSize}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(sentenceList[currentSentenceIndex].emoji, emojiTarget.x + emojiSize / 2, emojiTarget.y + emojiSize / 2);
        }

        function drawBullet() {
            if (isShooting) {
                ctx.fillStyle = "yellow";
                ctx.beginPath();
                ctx.arc(bulletX, bulletY, 5, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawGame() {
            if (!ctx) {
                console.error("Canvas context is not available.");
                return;
            }
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            drawGround();
            drawEmojiTarget();
            drawPlayer();
            drawBullet();
        }

        function gameLoop() {
            if (isShooting) {
                const targetX = emojiTarget.x + emojiSize / 2;
                const targetY = emojiTarget.y + emojiSize / 2;
                const deltaX = targetX - bulletX;
                const deltaY = targetY - bulletY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

                if (distance > bulletSpeed) {
                    bulletX += (deltaX / distance) * bulletSpeed;
                    bulletY += (deltaY / distance) * bulletSpeed;
                } else {
                    bulletX = targetX;
                    bulletY = targetY;
                    isShooting = false;
                    emojiTarget.cleared = true;
                    bulletX = playerX + playerSize * 0.7;
                    bulletY = playerY + playerSize * 0.5;
                    setTimeout(() => {
                        nextButton.disabled = false;
                    }, 500);
                }
            }
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        // --- Speech Recognition and Synthesis ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript.trim().toLowerCase();
                transcriptDiv.textContent = `B·∫°n n√≥i: ${transcript}`;
                provideFeedback(transcript);
                answerButton.disabled = false;
            };

            recognition.onerror = function(event) {
                console.error("L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i:", event.error);
                let errorMessage;
                switch (event.error) {
                    case 'no-speech':
                        errorMessage = "Kh√¥ng ph√°t hi·ªán gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.";
                        break;
                    case 'audio-capture':
                        errorMessage = "L·ªói thu √¢m thanh. Vui l√≤ng ki·ªÉm tra micro.";
                        break;
                    case 'not-allowed':
                        errorMessage = "Quy·ªÅn truy c·∫≠p micro b·ªã t·ª´ ch·ªëi. Vui l√≤ng c·∫•p quy·ªÅn trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.";
                        break;
                    default:
                        errorMessage = `L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i: ${event.error}. Vui l√≤ng th·ª≠ l·∫°i.`;
                }
                feedbackDiv.textContent = errorMessage;
                feedbackDiv.style.display = 'block';
                feedbackDiv.style.backgroundColor = '#f8d7da';
                feedbackDiv.style.borderColor = '#f5c6cb';
                speakText(errorMessage, 'vi-VN');
                answerButton.disabled = false;
            };

            recognition.onstart = function() {
                answerButton.disabled = true;
                transcriptDiv.textContent = "ƒêang nghe...";
                feedbackDiv.style.display = 'none';
            };

            recognition.onend = function() {
                answerButton.disabled = false;
                if (transcriptDiv.textContent === "ƒêang nghe...") {
                    transcriptDiv.textContent = "Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i.";
                    feedbackDiv.textContent = "Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i!";
                    feedbackDiv.style.display = 'block';
                    feedbackDiv.style.backgroundColor = '#fff3cd';
                    feedbackDiv.style.borderColor = '#ffeeba';
                    speakText("Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i!", 'vi-VN');
                }
            };
        } else {
            console.warn("Speech Recognition API not supported.");
            answerButton.disabled = true;
            answerButton.textContent = "üé§ API kh√¥ng h·ªó tr·ª£";
            questionArea.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n d·∫°ng gi·ªçng n√≥i. Vui l√≤ng d√πng Google Chrome.";
            feedbackDiv.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n d·∫°ng gi·ªçng n√≥i.";
            feedbackDiv.style.display = 'block';
            feedbackDiv.style.backgroundColor = '#f8d7da';
            feedbackDiv.style.borderColor = '#f5c6cb';
        }

        function speakText(text, lang = 'en-US') {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.onerror = (event) => {
                console.error("L·ªói ph√°t gi·ªçng n√≥i:", event.error);
            };
            speechSynthesis.speak(utterance);
        }

        function isCorrectSentence(spokenText, expectedSentence) {
            const normalizedSpoken = spokenText.trim().toLowerCase().replace(/[.,!]/g, '');
            const normalizedExpected = expectedSentence.toLowerCase().replace(/[.,!]/g, '');
            return normalizedSpoken === normalizedExpected || normalizedSpoken.replace(/\s+/g, ' ') === normalizedExpected;
        }

        function provideFeedback(spokenText) {
            feedbackDiv.style.display = 'block';
            const expectedSentence = sentenceList[currentSentenceIndex].sentence;

            if (isAnsweredCorrectly) {
                feedbackDiv.textContent = `B·∫°n ƒë·ªçc ƒë√∫ng r·ªìi!`;
                feedbackDiv.style.backgroundColor = '#d4edda';
                feedbackDiv.style.borderColor = '#c3e6cb';
                speakText(`B·∫°n ƒë·ªçc ƒë√∫ng r·ªìi!`, 'vi-VN');
                return;
            }

            let comment, speakFeedbackText;
            if (!spokenText || spokenText.trim() === "") {
                comment = "‚ö†Ô∏è Kh√¥ng ph√°t hi·ªán gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i!";
                speakFeedbackText = "Kh√¥ng ph√°t hi·ªán gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i!";
                feedbackDiv.style.backgroundColor = '#fff3cd';
                feedbackDiv.style.borderColor = '#ffeeba';
            } else if (isCorrectSentence(spokenText, expectedSentence)) {
                comment = `B·∫°n ƒë·ªçc ƒë√∫ng r·ªìi!`;
                speakFeedbackText = `B·∫°n ƒë·ªçc ƒë√∫ng r·ªìi!`;
                feedbackDiv.style.backgroundColor = '#d4edda';
                feedbackDiv.style.borderColor = '#c3e6cb';
                isAnsweredCorrectly = true;
                sentencesClearedSpan.textContent = currentSentenceIndex + 1;
                answerButton.disabled = true;
                nextButton.disabled = true;
                isShooting = true;
                if (shootSynth) {
                    shootSynth.triggerAttackRelease("C4", "32n");
                }
            } else {
                playerAttempts[currentSentenceIndex]++;
                comment = `B·∫°n ƒë·ªçc ch∆∞a ƒë√∫ng! H√£y th·ª≠ l·∫°i!`;
                speakFeedbackText = `B·∫°n ƒë·ªçc ch∆∞a ƒë√∫ng! H√£y th·ª≠ l·∫°i!`;
                feedbackDiv.style.backgroundColor = '#f8d7da';
                feedbackDiv.style.borderColor = '#f5c6cb';
                if (playerAttempts[currentSentenceIndex] >= 3) {
                    comment += ` B·∫°n ƒë√£ th·ª≠ sai 3 l·∫ßn. Nh·∫•n "C√¢u ti·∫øp theo" ƒë·ªÉ ti·∫øp t·ª•c!`;
                    speakFeedbackText += ` B·∫°n ƒë√£ th·ª≠ sai ba l·∫ßn. Nh·∫•n C√¢u ti·∫øp theo ƒë·ªÉ ti·∫øp t·ª•c!`;
                    nextButton.disabled = false;
                    answerButton.disabled = true;
                }
            }

            feedbackDiv.textContent = comment;
            speakText(speakFeedbackText, 'vi-VN');
        }

        function loadSentence(index) {
            if (index >= sentenceList.length) {
                questionArea.textContent = "Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u!";
                targetSentenceArea.style.display = 'none';
                disableButtonsOnComplete();
                displayResults();
                return false;
            }

            const sentenceData = sentenceList[index];
            isAnsweredCorrectly = false;
            questionArea.textContent = `C√¢u h·ªèi: What do you have?`;
            targetSentenceArea.textContent = sentenceData.sentence;
            targetSentenceArea.style.display = 'block';
            transcriptDiv.textContent = '';
            feedbackDiv.style.display = 'none';
            answerButton.disabled = false;
            nextButton.disabled = true;
            startButton.disabled = false;
            initializeEmojiTarget();
            return true;
        }

        function speakQuestion() {
            if (currentSentenceIndex >= sentenceList.length) return;
            speakText("What do you have?", 'en-US');
        }

        function startRecognition() {
            if (recognition) {
                try {
                    recognition.start();
                } catch (e) {
                    console.error("L·ªói khi b·∫Øt ƒë·∫ßu nh·∫≠n d·∫°ng gi·ªçng n√≥i:", e);
                    feedbackDiv.textContent = "L·ªói khi b·∫Øt ƒë·∫ßu nh·∫≠n d·∫°ng gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.";
                    feedbackDiv.style.display = 'block';
                    feedbackDiv.style.borderColor = '#f5c6cb';
                }
            } else {
                feedbackDiv.textContent = "Nh·∫≠n d·∫°ng gi·ªçng n√≥i kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát n√†y.";
                feedbackDiv.style.display = 'block';
                feedbackDiv.style.backgroundColor = '#f8d7da';
                feedbackDiv.style.borderColor = '#f5c6cb';
            }
        }

        function nextSentence() {
            currentSentenceIndex++;
            if (loadSentence(currentSentenceIndex)) {
                speakQuestion();
            }
        }

        function disableButtonsOnComplete() {
            startButton.disabled = true;
            answerButton.disabled = true;
            nextButton.disabled = true;
            viewResultsButton.disabled = false;
        }

        function displayResults() {
            resultsDisplayArea.innerHTML = '';

            let resultHTML = "<h3>B·∫£ng K·∫øt Qu·∫£ Tr·∫£ L·ªùi</h3>";
            const list = sentenceList.map((sentenceData, i) => {
                const attempts = playerAttempts[i];
                const isCleared = i < currentSentenceIndex || (i === currentSentenceIndex && isAnsweredCorrectly);
                const status = isCleared ? "‚úÖ ƒê√£ tr·∫£ l·ªùi ƒë√∫ng" : "‚ùå Ch∆∞a tr·∫£ l·ªùi ƒë√∫ng";
                const attemptsText = isCleared && attempts === 0 ? "(ƒê·ªçc t·ªët)" : (attempts > 0 ? `(S·ªë l·∫ßn th·ª≠: ${attempts})` : "(Ch∆∞a th·ª≠)");
                return `<p><strong>C√¢u ${i + 1}:</strong> ${sentenceData.sentence} ${sentenceData.emoji}<br/>
                        <em>Tr·∫°ng th√°i:</em> ${status} ${attemptsText}</p>`;
            }).join('');

            resultHTML += list;
            resultHTML += `<button onclick="window.shareGeneratedResults()">üì§ Chia s·∫ª k·∫øt qu·∫£ n√†y</button>`;
            resultHTML += `<div id="copyFeedback" style="display:none;"></div>`;

            resultsDisplayArea.innerHTML = resultHTML;
            resultsDisplayArea.style.display = 'block';
            resultsDisplayArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function shareGeneratedResults() {
            const listItems = sentenceList.map((sentenceData, i) => {
                const attempts = playerAttempts[i];
                const isCleared = i < currentSentenceIndex || (i === currentSentenceIndex && isAnsweredCorrectly);
                const status = isCleared ? "ƒê√£ tr·∫£ l·ªùi ƒë√∫ng" : "Ch∆∞a tr·∫£ l·ªùi ƒë√∫ng";
                const attemptsText = isCleared && attempts === 0 ? "(ƒê·ªçc t·ªët)" : (attempts > 0 ? `(S·ªë l·∫ßn th·ª≠: ${attempts})` : "(Ch∆∞a th·ª≠)");
                return `
                    <div style="margin-bottom: 15px; padding-bottom:10px; border-bottom: 1px solid #eee;">
                        <p style="font-weight: bold; color: #0056b3; margin-bottom: 5px;">C√¢u ${i + 1}: ${sentenceData.sentence} ${sentenceData.emoji}</p>
                        <p style="margin-top:5px;"><em>Tr·∫°ng th√°i:</em> ${status} ${attemptsText}</p>
                    </div>`;
            }).join('');

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="vi">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>K·∫øt qu·∫£ Tr·∫£ L·ªùi c·ªßa B√©</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; line-height: 1.6; }
                        .container-result { max-width: 700px; margin: 20px auto; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                        h2 { color: #0056b3; text-align: center; border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-bottom: 25px; }
                        p { margin-bottom: 8px; }
                        em { font-style: italic; color: #555; }
                        button { 
                            display: block; 
                            margin: 20px auto; 
                            padding: 10px 20px; 
                            font-size: 1em; 
                            border: none; 
                            border-radius: 5px; 
                            cursor: pointer; 
                            background: #007bff; 
                            color: white; 
                            transition: background-color 0.3s ease; 
                        }
                        button:hover { background: #0056b3; }
                    </style>
                </head>
                <body>
                    <div class="container-result">
                        <h2>K·∫øt qu·∫£ Tr·∫£ L·ªùi - L√≠nh ƒê·∫∑c C√¥ng</h2>
                        ${listItems}
                        <p style="text-align:center; margin-top:25px; font-size:0.9em; color: #777;">K·∫øt qu·∫£ ƒë∆∞·ª£c t·∫°o v√†o l√∫c: ${new Date().toLocaleString('vi-VN')}</p>
                        <button onclick="window.close()">‚¨ÖÔ∏è Quay tr·ªü v·ªÅ m√†n h√¨nh ch√≠nh</button>
                    </div>
                </body>
                </html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const copyFeedbackDiv = document.getElementById("copyFeedback");
            copyFeedbackDiv.style.display = 'block';

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    copyFeedbackDiv.innerHTML = `üîó Link k·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c sao ch√©p! B·∫°n c√≥ th·ªÉ d√°n (Ctrl+V ho·∫∑c Command+V) ƒë·ªÉ chia s·∫ª. Ho·∫∑c <a href="${url}" target="_blank" rel="noopener noreferrer">xem k·∫øt qu·∫£ t·∫°i ƒë√¢y</a>.`;
                }).catch(err => {
                    console.error('Kh√¥ng th·ªÉ sao ch√©p link t·ª± ƒë·ªông: ', err);
                    copyFeedbackDiv.innerHTML = `Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p link. Vui l√≤ng sao ch√©p th·ªß c√¥ng: <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
                });
            } else {
                copyFeedbackDiv.innerHTML = `Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ sao ch√©p t·ª± ƒë·ªông. Vui l√≤ng sao ch√©p link sau ƒë·ªÉ chia s·∫ª: <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            }
            window.open(url, '_blank');
        }

        // --- Initialization ---

        window.loadSentence = loadSentence;
        window.speakQuestion = speakQuestion;
        window.startRecognition = startRecognition;
        window.nextSentence = nextSentence;
        window.displayResults = displayResults;
        window.shareGeneratedResults = shareGeneratedResults;
        window.isCorrectSentence = isCorrectSentence;
        window.initializeEmojiTarget = initializeEmojiTarget;
        window.handleFirstInteraction = handleFirstInteraction;

        function initGame() {
            console.log("Initializing game...");
            totalSentencesSpan.textContent = sentenceList.length;
            resizeCanvas();
            document.addEventListener('click', window.handleFirstInteraction, { once: true });
        }

        function handleFirstInteraction() {
            console.log("First user interaction detected.");
            if (!shootSynth) {
                try {
                    shootSynth = new Tone.Synth({
                        oscillator: { type: "square" },
                        envelope: { attack: 0.001, decay: 0.05, sustain: 0.01, release: 0.1 }
                    }).toDestination();
                    console.log("Tone.js shootSynth initialized.");
                } catch (e) {
                    console.error("L·ªói kh·ªüi t·∫°o Tone.js:", e);
                }
            }

            if (Tone.context.state !== 'running') {
                Tone.context.resume().then(() => {
                    console.log('AudioContext resumed successfully.');
                }).catch(e => {
                    console.error('Error resuming AudioContext:', e);
                });
            }

            loadSentence(currentSentenceIndex);
            gameLoop();
        }

        window.onload = initGame;
    </script>
</body>
</html>
